---

- name: Add Etcher apt key
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 379CE192D401AB61
  become: yes
  become_method: sudo

- name: Add Etcher apt repository
  apt_repository:
    repo: deb https://deb.etcher.io stable etcher
    filename: balena_etcher
    state: present
  become: yes
  become_method: sudo

- name: Install Balena Etcher
  apt:
    name:
    - balena-etcher-electron
    update_cache: yes
    state: present
  become: yes
  become_method: sudo

- name: Get latest release from balena-io/etcher
  community.general.github_release:
    user: balena-io
    repo: etcher
    action: latest_release
  register: etcher_latest_version

# - name: Unarchive the Balena Etcher {{ etcher_latest_version.tag }} installer package
#   unarchive:
#     url: https://github.com/balena-io/etcher/releases/download/{{ etcher_latest_version.tag }}/balena-etcher-electron-{{ etcher_latest_version.tag | regex_replace('^v', '') }}-linux-x64.zip
#     dest: "{{ downloads_dir }}/balena-etcher-electron-{{ etcher_version }}-linux-x64"
#     remote_src: yes
#   when: "'64' in ansible_architecture and 'Linux' == ansible_system"

# - name: Run Balena Etcher installer
#   command: "bash pyenv-installer"
#   args:
#     chdir: "{{ home_dir }}"
#     creates: "{{ home_dir }}/.pyenv"

# - set_fact:
#     etcher_version: 1.5.109

# - name: Download Balena Etcher installer package for Linux amd64
#   get_url:
#     url: https://github.com/balena-io/etcher/releases/download/v{{ etcher_version }}/balena-etcher-electron-{{ etcher_version }}-linux-x64.zip
#     dest: "{{ downloads_dir }}/balena-etcher-electron-{{ etcher_version }}-linux-x64.zip"
#   when: "'64' in ansible_architecture and 'Linux' == ansible_system"

# - name: Unzip Balena Etcher installer archive
#   zip:
#     path: "{{ downloads_dir }}/balena-etcher-electron-{{ etcher_version }}-linux-x64.zip"
#     mode: 0770

# - name: Set executable flag in Balena Etcher installer file
#   file:
#     path: "{{ downloads_dir }}/balena-etcher-electron-{{ etcher_version }}-linux-x64.zip"
#     mode: 0770

# - name: Run Balena Etcher installer
#   command: "bash pyenv-installer"
#   args:
#     chdir: "{{ home_dir }}"
#     creates: "{{ home_dir }}/.pyenv"
